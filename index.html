<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг сообщений СЭДО</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Стили для экрана загрузки */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
            animation: logoPulse 2s infinite ease-in-out;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            text-align: center;
            opacity: 0.9;
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2 0%, #ffb300 100%);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes logoPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Остальные стили (остаются без изменений) */
        /* CSS переменные для тем */
        :root {
            --primary-color: #2a5298;
            --primary-dark: #1e3c72;
            --primary-light: #4a90e2;
            --secondary-color: #ffb300;
            --secondary-dark: #ff8f00;
            --background-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --border-color: #d1d9e6;
            --success-color: #1a8754;
            --error-color: #d32f2f;
            --warning-color: #ff9800;
            --achievement-color: #9c27b0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --tab-active: #4a90e2;
            --tab-inactive: #e0e0e0;
        }

        /* Темная тема */
        .theme-dark {
            --primary-color: #4a90e2;
            --primary-dark: #2a5298;
            --primary-light: #6eb0ff;
            --secondary-color: #ffb300;
            --secondary-dark: #ff8f00;
            --background-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-light: #aaaaaa;
            --border-color: #333333;
            --achievement-color: #ba68c8;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --tab-active: #6eb0ff;
            --tab-inactive: #333333;
        }
        /* Зеленая тема */
        .theme-green {
            --primary-color: #1a8754;
            --primary-dark: #0d5c3a;
            --primary-light: #4caf50;
            --secondary-color: #8bc34a;
            --secondary-dark: #689f38;
            --background-color: #e8f5e9;
            --card-bg: #ffffff;
            --text-color: #1b5e20;
            --text-light: #4caf50;
            --border-color: #c8e6c9;
            --achievement-color: #7b1fa2;
            --tab-active: #4caf50;
            --tab-inactive: #c8e6c9;
        }

        /* Оранжевая тема */
        .theme-orange {
            --primary-color: #f57c00;
            --primary-dark: #e65100;
            --primary-light: #ffb74d;
            --secondary-color: #ff9800;
            --secondary-dark: #f57c00;
            --background-color: #fff3e0;
            --card-bg: #ffffff;
            --text-color: #bf360c;
            --text-light: #ff9800;
            --border-color: #ffe0b2;
            --achievement-color: #7b1fa2;
            --tab-active: #ffb74d;
            --tab-inactive: #ffe0b2;
        }

        /* Розовая тема */
        .theme-pink {
            --primary-color: #e91e63;
            --primary-dark: #ad1457;
            --primary-light: #f48fb1;
            --secondary-color: #ec407a;
            --secondary-dark: #d81b60;
            --background-color: #fce4ec;
            --card-bg: #ffffff;
            --text-color: #880e4f;
            --text-light: #c2185b;
            --border-color: #f8bbd9;
            --achievement-color: #9c27b0;
            --tab-active: #f48fb1;
            --tab-inactive: #f8bbd9;
        }

        /* Кнопка достижений в углу экрана */
        .achievements-floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--achievement-color) 0%, var(--primary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .achievements-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .achievements-floating-btn:active {
            transform: scale(0.95);
        }

        .achievements-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid var(--card-bg);
        }

        /* Модальное окно достижений */
        .achievements-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .achievements-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievements-modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .achievements-modal-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .achievements-modal-header h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .achievements-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .achievements-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .achievements-modal-body {
            padding: 20px;
        }

        /* Анимированные фоны - ЛАВА */
        .bg-lava {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            display: none;
        }

        .bg-lava.active {
            display: block;
        }

        .lava-blob {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--achievement-color) 50%, var(--secondary-color) 100%);
            filter: blur(40px);
            opacity: 0.6;
            mix-blend-mode: multiply;
        }

        .lava-blob:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 20%;
            left: 10%;
            animation: lavaFloat1 20s infinite ease-in-out;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }

        .lava-blob:nth-child(2) {
            width: 400px;
            height: 400px;
            bottom: 10%;
            right: 15%;
            animation: lavaFloat2 25s infinite ease-in-out;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .lava-blob:nth-child(3) {
            width: 350px;
            height: 350px;
            top: 60%;
            left: 30%;
            animation: lavaFloat3 30s infinite ease-in-out;
            background: linear-gradient(135deg, #ffd166 0%, #ffb347 100%);
        }

        .lava-blob:nth-child(4) {
            width: 250px;
            height: 250px;
            top: 10%;
            right: 25%;
            animation: lavaFloat4 22s infinite ease-in-out;
            background: linear-gradient(135deg, #9d4edd 0%, #7b2cbf 100%);
        }

        .lava-blob:nth-child(5) {
            width: 320px;
            height: 320px;
            bottom: 30%;
            left: 20%;
            animation: lavaFloat5 28s infinite ease-in-out;
            background: linear-gradient(135deg, #00bbf9 0%, #00b4d8 100%);
        }

        @keyframes lavaFloat1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
            25% {
                transform: translate(50px, -80px) scale(1.2);
                border-radius: 40% 60% 70% 30% / 40% 70% 30% 60%;
            }
            50% {
                transform: translate(100px, 30px) scale(0.9);
                border-radius: 70% 30% 50% 50% / 30% 50% 50% 70%;
            }
            75% {
                transform: translate(-30px, 60px) scale(1.1);
                border-radius: 30% 70% 60% 40% / 70% 60% 40% 30%;
            }
        }

        @keyframes lavaFloat2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 50% 50% 20% 80% / 25% 80% 20% 75%;
            }
            33% {
                transform: translate(-80px, 40px) scale(1.3);
                border-radius: 80% 20% 75% 25% / 20% 75% 25% 80%;
            }
            66% {
                transform: translate(60px, -60px) scale(0.8);
                border-radius: 25% 75% 80% 20% / 75% 20% 25% 80%;
            }
        }

        @keyframes lavaFloat3 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 40% 60% 70% 30% / 60% 40% 30% 70%;
            }
            25% {
                transform: translate(-100px, -30px) scale(1.4);
                border-radius: 60% 40% 30% 70% / 40% 60% 70% 30%;
            }
            50% {
                transform: translate(70px, 90px) scale(0.7);
                border-radius: 30% 70% 40% 60% / 70% 30% 60% 40%;
            }
            75% {
                transform: translate(-40px, -70px) scale(1.2);
                border-radius: 70% 30% 60% 40% / 30% 70% 40% 60%;
            }
        }

        @keyframes lavaFloat4 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 55% 45% 35% 65% / 55% 35% 65% 45%;
            }
            50% {
                transform: translate(120px, -40px) scale(1.1);
                border-radius: 45% 55% 65% 35% / 35% 65% 45% 55%;
            }
        }

        @keyframes lavaFloat5 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 65% 35% 75% 25% / 35% 75% 25% 65%;
            }
            33% {
                transform: translate(-60px, 80px) scale(1.3);
                border-radius: 35% 65% 25% 75% / 75% 25% 65% 35%;
            }
            66% {
                transform: translate(90px, -20px) scale(0.9);
                border-radius: 75% 25% 65% 35% / 25% 65% 35% 75%;
            }
        }

        /* Эффект пузырьков */
        .lava-bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: bubbleFloat 15s infinite linear;
        }

        @keyframes bubbleFloat {
            0% {
                transform: translateY(100vh) translateX(0) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100px) translateX(calc(100vw + 50px)) scale(1);
                opacity: 0;
            }
        }

        /* Улучшенные превью фонов */
        .background-preview {
            width: 100%;
            height: 40px;
            border-radius: 4px;
            margin-bottom: 8px;
            overflow: hidden;
            position: relative;
            background-size: 400% 400% !important;
            animation: previewAnimation 4s ease infinite;
        }

        @keyframes previewAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .background-preview.bg-lava {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #ffd166 50%, #9d4edd 75%, #00bbf9 100%);
            position: relative;
            overflow: hidden;
        }

        .background-preview.bg-lava::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            border-radius: 50%;
            animation: previewLava1 3s ease infinite;
            opacity: 0.7;
            filter: blur(5px);
        }

        .background-preview.bg-lava::after {
            content: '';
            position: absolute;
            bottom: 15px;
            right: 20px;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            border-radius: 50%;
            animation: previewLava2 4s ease infinite;
            opacity: 0.7;
            filter: blur(5px);
        }

        @keyframes previewLava1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
            50% {
                transform: translate(15px, -5px) scale(1.2);
                border-radius: 40% 60% 70% 30% / 40% 70% 30% 60%;
            }
        }

        @keyframes previewLava2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                border-radius: 50% 50% 20% 80% / 25% 80% 20% 75%;
            }
            50% {
                transform: translate(-10px, 8px) scale(1.3);
                border-radius: 80% 20% 75% 25% / 20% 75% 25% 80%;
            }
        }

        .background-name {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            font-size: 11px;
            z-index: 2;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Стили для уведомления об обновлении */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 179, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 179, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 179, 0, 0); }
        }

        .update-notification {
            animation: slideIn 0.3s ease;
        }

        .update-available-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--secondary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        /* Стили для сообщений */
        .message-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
            border-left: 4px solid var(--secondary-color);
        }

        .message-notification.error {
            background: linear-gradient(135deg, var(--error-color) 0%, #b71c1c 100%);
            border-left-color: #ff5252;
        }

        .message-notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #0d5c3a 100%);
            border-left-color: #4caf50;
        }

        .message-notification.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #f57c00 100%);
            border-left-color: #ffb300;
        }

        /* Контекстное меню для полей ввода */
        .input-context-menu {
            position: fixed;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 180px;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        .input-context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--text-color);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: var(--background-color);
        }

        .context-menu-item:active {
            background-color: var(--primary-light);
            color: white;
        }

        .context-menu-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 4px 0;
        }

        /* Эффекты для полей ввода при операциях с буфером обмена */
        .search-input.copied {
            border-color: var(--success-color) !important;
            box-shadow: 0 0 0 2px rgba(26, 135, 84, 0.1) !important;
        }

        .search-input.pasted {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.1) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            padding: 15px;
            min-height: 100vh;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* Панель настроек - компактная */
        .settings-panel {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .settings-title {
            font-size: 16px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-content {
            display: none;
        }
        
        .settings-content.active {
            display: block;
        }
        
        /* Выбор темы - компактный */
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .theme-option {
            padding: 12px 8px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 13px;
        }
        
        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .theme-option.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        .theme-preview {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            margin-bottom: 8px;
        }
        
        /* Заголовок */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Вкладки */
        .tabs {
            display: flex;
            background-color: var(--card-bg);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            background-color: var(--tab-inactive);
            border: none;
            outline: none;
        }
        
        .tab:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .tab.active {
            background-color: var(--tab-active);
            color: white;
        }
        
        /* Контент вкладок */
        .tab-content {
            display: none;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            border-top: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Панель поиска */
        .search-panel {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .search-title {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-title i {
            color: var(--primary-light);
        }
        
        /* Выбор типа поиска */
        .search-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .search-type-btn {
            padding: 10px 12px;
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .search-type-btn:hover {
            border-color: var(--primary-light);
        }
        
        .search-type-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Подразделы - сворачиваемые */
        .subsection {
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .subsection-header {
            background-color: var(--card-bg);
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .subsection-header:hover {
            background-color: var(--background-color);
        }
        
        .subsection-header.active {
            border-bottom: 1px solid var(--border-color);
        }
        
        .subsection-title {
            font-size: 16px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        
        .subsection-toggle {
            transition: transform 0.3s ease;
            color: var(--text-light);
        }
        
        .subsection-header.active .subsection-toggle {
            transform: rotate(180deg);
        }
        
        .subsection-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background-color: var(--card-bg);
        }
        
        .subsection-content.active {
            max-height: 1000px;
            padding: 15px;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 768px) {
            .date-inputs {
                grid-template-columns: 1fr;
            }
        }
        
        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .date-label {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .search-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .search-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .search-btn:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
        }
        
        .search-example {
            font-size: 13px;
            color: var(--text-light);
            background-color: var(--background-color);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid var(--primary-light);
            margin-top: 12px;
        }
        
        .search-example span {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Индикатор загрузки */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ошибки */
        .error-panel {
            display: none;
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--error-color);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--error-color);
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .error-panel.active {
            display: block;
        }
        
        /* Сообщение не найдено */
        .not-found-panel {
            display: none;
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--warning-color);
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .not-found-panel.active {
            display: block;
        }
        
        /* Основной контент */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 16px;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title i {
            color: var(--primary-light);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .info-item {
            padding: 8px 0;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-label i {
            color: var(--primary-light);
            font-size: 12px;
        }
        
        .info-value {
            font-size: 14px;
            color: var(--text-color);
            word-break: break-word;
            padding: 6px 0;
        }
        
        .highlight {
            background-color: rgba(255, 179, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid var(--secondary-color);
        }
        
        /* Сообщения */
        .messages-container {
            grid-column: 1 / -1;
        }
        
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .message-card {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
            cursor: pointer;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        
        .message-card:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-card.expanded {
            border-left-color: var(--primary-light);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .message-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .message-type {
            background-color: rgba(74, 144, 226, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .message-date {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        
        .message-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            display: none;
        }
        
        .message-card.expanded .message-details {
            display: grid;
        }
        
        /* Документы */
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .document-card {
            background-color: var(--card-bg);
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .document-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            word-break: break-word;
        }
        
        .document-id {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 12px;
            font-family: monospace;
        }
        
        .document-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Статус */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-success {
            background-color: rgba(26, 135, 84, 0.1);
            color: var(--success-color);
        }
        
        .status-error {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--error-color);
        }
        
        .status-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        /* Подписка - результаты */
        .subscription-result {
            display: none;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-top: 15px;
        }
        
        .subscription-result.active {
            display: block;
        }
        
        .subscription-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .status-icon {
            font-size: 32px;
        }
        
        .status-icon.active {
            color: var(--success-color);
        }
        
        .status-icon.inactive {
            color: var(--error-color);
        }
        
        .status-text {
            font-size: 20px;
            font-weight: 600;
        }
        
        .status-text.active {
            color: var(--success-color);
        }
        
        .status-text.inactive {
            color: var(--error-color);
        }
        
        .subscription-details {
            background-color: var(--background-color);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .detail-value {
            color: var(--text-color);
            font-weight: 500;
            font-size: 13px;
        }
        
        /* Достижения */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--achievement-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        .achievement-notification.active {
            display: block;
        }
        
        .achievement-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .achievement-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .achievement-desc {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .achievement-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .achievement-card.locked {
            opacity: 0.7;
        }
        
        .achievement-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--achievement-color) 0%, var(--primary-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .achievement-badge.locked {
            background: var(--text-light);
        }
        
        .achievement-content {
            flex: 1;
        }
        
        .achievement-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .achievement-description {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .achievement-progress {
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--achievement-color) 0%, var(--primary-color) 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .achievement-progress-text {
            font-size: 12px;
            color: var(--text-light);
            text-align: right;
            margin-top: 3px;
        }
        
        /* Подвал */
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 12px;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .theme-selector, .info-grid, .message-details, .search-type-selector {
                grid-template-columns: 1fr;
            }
            
            .search-type-selector {
                flex-direction: column;
            }
            
            .message-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .message-type {
                margin-top: 8px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-btn {
                width: 100%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                padding: 12px;
            }
            
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .achievement-notification {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .achievements-floating-btn {
                bottom: 15px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .achievements-badge {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }
            
            .achievements-modal-content {
                width: 95%;
            }
        }
    </style>
</head>
<body class="theme-default">
    <!-- Экран загрузки -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <img src="https://career.astral.ru/local/templates/hr/assets/favicon/android-chrome-512x512.png" alt="Astral Логотип">
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Загрузка системы мониторинга</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
    </div>
    
    <!-- Анимированный фон ЛАВА -->
    <div class="bg-lava" id="bgLava">
        <div class="lava-blob"></div>
        <div class="lava-blob"></div>
        <div class="lava-blob"></div>
        <div class="lava-blob"></div>
        <div class="lava-blob"></div>
    </div>
    
    <!-- Плавающая кнопка достижений -->
    <div class="achievements-floating-btn" id="achievementsFloatBtn">
        <i class="fas fa-trophy"></i>
        <div class="achievements-badge" id="achievementsFloatBadge">0</div>
    </div>
    
    <!-- Модальное окно достижений -->
    <div class="achievements-modal" id="achievementsModal">
        <div class="achievements-modal-content">
            <div class="achievements-modal-header">
                <h2><i class="fas fa-trophy"></i> Достижения</h2>
                <button class="achievements-modal-close" id="achievementsModalClose">&times;</button>
            </div>
            <div class="achievements-modal-body">
                <!-- Статистика -->
                <div class="info-grid" style="margin-bottom: 20px;">
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-trophy"></i> Всего достижений</div>
                        <div class="info-value">4</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-star"></i> Ваш прогресс</div>
                        <div class="info-value" id="achievementsProgress">0%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-search"></i> Всего проверок</div>
                        <div class="info-value" id="totalChecks">0</div>
                    </div>
                </div>
                
                <!-- Список достижений -->
                <div id="achievementsList">
                    <!-- Достижения будут загружены через JavaScript -->
                </div>
                
                <!-- Выбор фона -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <h3 class="settings-title"><i class="fas fa-image"></i> Анимированный фон "Лава"</h3>
                    <div class="theme-selector" id="backgroundSelector">
                        <!-- Фоны будут добавляться динамически -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Контекстное меню для полей ввода -->
    <div class="input-context-menu" id="inputContextMenu">
        <div class="context-menu-item" data-action="cut">
            <i class="fas fa-cut"></i> Вырезать
        </div>
        <div class="context-menu-item" data-action="copy">
            <i class="far fa-copy"></i> Копировать
        </div>
        <div class="context-menu-item" data-action="paste">
            <i class="fas fa-paste"></i> Вставить
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="selectAll">
            <i class="fas fa-mouse-pointer"></i> Выделить всё
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="clear">
            <i class="fas fa-trash-alt"></i> Очистить
        </div>
    </div>

    <div class="container">
        <!-- Панель настроек -->
        <div class="settings-panel">
            <div class="settings-header" id="settingsToggle">
                <h2 class="settings-title"><i class="fas fa-sliders-h"></i> Настройки </h2>
                <span id="settingsIcon"><i class="fas fa-chevron-down"></i></span>
            </div>
            
            <div class="settings-content" id="settingsContent">
                <!-- Выбор темы -->
                <div class="theme-selector">
                    <div class="theme-option active" data-theme="default">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 50%, #2a5298 100%);"></div>
                        <div>Светлая</div>
                    </div>
                    <div class="theme-option" data-theme="dark">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #121212 0%, #1e1e1e 50%, #4a90e2 100%);"></div>
                        <div>Темная</div>
                    </div>
                    <div class="theme-option" data-theme="green">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 50%, #1a8754 100%);"></div>
                        <div>Зеленая</div>
                    </div>
                    <div class="theme-option" data-theme="orange">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #fff3e0 0%, #ffffff 50%, #f57c00 100%);"></div>
                        <div>Оранжевая</div>
                    </div>
                    <div class="theme-option" data-theme="pink">
                        <div class="theme-preview" style="background: linear-gradient(135deg, #fce4ec 0%, #ffffff 50%, #e91e63 100%);"></div>
                        <div>Розовая</div>
                    </div>
                </div>
                
                <!-- Статистика -->
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-trophy"></i> Получено достижений</div>
                        <div class="info-value" id="achievementsCount">0/4</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-search"></i> Всего проверок</div>
                        <div class="info-value" id="totalChecks2">0</div>
                    </div>
                </div>
                
                <!-- Кнопка проверки обновлений -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-sync-alt"></i> Версия приложения</div>
                        <div class="info-value" id="appVersion">1.1.2</div>
                    </div>
                    <button id="manualCheckUpdate" class="search-btn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-sync-alt"></i> Проверить обновления
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Уведомление о достижении -->
        <div class="achievement-notification" id="achievementNotification">
            <div style="display: flex; align-items: center;">
                <div class="achievement-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <div class="achievement-title" id="achievementNotificationTitle">Новое достижение!</div>
                    <div class="achievement-desc" id="achievementNotificationDesc">Описание достижения</div>
                </div>
            </div>
        </div>
        
        <!-- Заголовок -->
        <div class="header">
            <h1><i class="fas fa-search"></i> Мониторинг сообщений СЭДО</h1>
            <p class="subtitle">Проверка подписки на оператора и поиск информации о сообщениях</p>
        </div>
        
        <!-- Вкладки -->
        <div class="tabs">
            <button class="tab" data-tab="messages">
                <i class="fas fa-envelope"></i> Поиск сообщений
            </button>
            <button class="tab active" data-tab="subscription">
                <i class="fas fa-user-check"></i> Проверка подписки
            </button>
        </div>
        
        <!-- Вкладка 1: Проверка подписки -->
        <div id="subscription-tab" class="tab-content active">
            <div class="search-panel">
                <h2 class="search-title"><i class="fas fa-user-check"></i> Проверка подписки на оператора</h2>
                
                <!-- Выбор типа проверки -->
                <div class="search-type-selector" id="subscriptionTypeSelector">
                    <button class="search-type-btn active" data-type="inn">
                        <i class="fas fa-id-card"></i> По ИНН
                    </button>
                    <button class="search-type-btn" data-type="regnum">
                        <i class="fas fa-user"></i> По рег.номеру СФР
                    </button>
                </div>
                
                <!-- Ввод данных -->
                <div class="search-box">
                    <input type="text" id="subscriptionInput" class="search-input" 
                           placeholder="Введите ИНН клиента (10 или 12 цифр)">
                    <button id="subscriptionButton" class="search-btn">
                        <i class="fas fa-search"></i> Проверить
                    </button>
                </div>
                
                <!-- Примеры -->
                <div class="search-example">
                    <p><strong>Примеры:</strong> <span>7712345678</span> (ИНН юр.лица) • <span>123456789012</span> (ИНН физ.лица) • <span>2322720573</span> (рег.номер СФР)</p>
                </div>
            </div>
            
            <!-- Индикатор загрузки -->
            <div id="subscriptionLoadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Проверяем подписку на оператора...</p>
            </div>
            
            <!-- Панель ошибок -->
            <div id="subscriptionErrorPanel" class="error-panel">
                <h3><i class="fas fa-exclamation-triangle"></i> Ошибка проверки подписки</h3>
                <p id="subscriptionErrorMessage"></p>
            </div>
            
            <!-- Результат проверки подписки -->
            <div id="subscriptionResult" class="subscription-result">
                <!-- Результаты будут загружены через JavaScript -->
            </div>
        </div>
        
        <!-- Вкладка 2: Поиск сообщений -->
        <div id="messages-tab" class="tab-content">
            <div class="search-panel">
                <h2 class="search-title"><i class="fas fa-envelope"></i> Поиск сообщений СЭДО</h2>
                
                <!-- Подраздел 1: Поиск по ID сообщения -->
                <div class="subsection" id="subsectionMessageId">
                    <div class="subsection-header active">
                        <h3 class="subsection-title"><i class="fas fa-envelope"></i> Поиск по ID сообщения</h3>
                        <span class="subsection-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="subsection-content active">
                        <div class="search-box">
                            <input type="text" id="messageIdInput" class="search-input" 
                                   placeholder="Введите ID сообщения (например: f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3)">
                            <button id="messageIdButton" class="search-btn">
                                <i class="fas fa-search"></i> Найти сообщение
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Подраздел 2: Поиск по клиенту -->
                <div class="subsection" id="subsectionClient">
                    <div class="subsection-header">
                        <h3 class="subsection-title"><i class="fas fa-user"></i> Поиск по клиенту</h3>
                        <span class="subsection-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="subsection-content">
                        <!-- Выбор типа поиска клиента -->
                        <div class="search-type-selector" id="clientSearchTypeSelector">
                            <button class="search-type-btn active" data-type="clientRegNum">
                                <i class="fas fa-user"></i> По рег.номеру СФР
                            </button>
                            <button class="search-type-btn" data-type="clientGuid">
                                <i class="fas fa-key"></i> По GUID УЗ
                            </button>
                            <button class="search-type-btn" data-type="clientInn">
                                <i class="fas fa-id-card"></i> По ИНН клиента
                            </button>
                        </div>
                        
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label class="date-label"><i class="far fa-calendar-alt"></i> Дата начала</label>
                                <input type="date" id="clientStartDate" class="search-input" value="">
                            </div>
                            <div class="date-input-group">
                                <label class="date-label"><i class="far fa-calendar-alt"></i> Дата окончания</label>
                                <input type="date" id="clientEndDate" class="search-input" value="">
                            </div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="clientSearchInput" class="search-input" 
                                   placeholder="Введите рег.номер клиента СФР (например: 123-456-789)">
                            <button id="clientSearchButton" class="search-btn">
                                <i class="fas fa-search"></i> Найти документы клиента
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Подраздел 3: Поиск по налогоплательщику -->
                <div class="subsection" id="subsectionInsurant">
                    <div class="subsection-header">
                        <h3 class="subsection-title"><i class="fas fa-building"></i> Поиск по налогоплательщику (1С УП)</h3>
                        <span class="subsection-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="subsection-content">
                        <!-- Выбор типа поиска налогоплательщика -->
                        <div class="search-type-selector" id="insurantSearchTypeSelector">
                            <button class="search-type-btn active" data-type="insurantRegNum">
                                <i class="fas fa-building"></i> По рег.номеру ФСС
                            </button>
                            <button class="search-type-btn" data-type="insurantInn">
                                <i class="fas fa-landmark"></i> По ИНН НП
                            </button>
                        </div>
                        
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label class="date-label"><i class="far fa-calendar-alt"></i> Дата начала</label>
                                <input type="date" id="insurantStartDate" class="search-input" value="">
                            </div>
                            <div class="date-input-group">
                                <label class="date-label"><i class="far fa-calendar-alt"></i> Дата окончания</label>
                                <input type="date" id="insurantEndDate" class="search-input" value="">
                            </div>
                        </div>
                        
                        <div class="search-box">
                            <input type="text" id="insurantSearchInput" class="search-input" 
                                   placeholder="Введите рег.номер налогоплательщика в ФСС">
                            <button id="insurantSearchButton" class="search-btn">
                                <i class="fas fa-search"></i> Найти документы НП
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Индикатор загрузки -->
            <div id="messagesLoadingIndicator" class="loading">
                <div class="spinner"></div>
                <p>Подключаемся к серверу СЭДО...</p>
            </div>
            
            <!-- Панель ошибок -->
            <div id="messagesErrorPanel" class="error-panel">
                <h3><i class="fas fa-exclamation-triangle"></i> Ошибка загрузки данных</h3>
                <p id="messagesErrorMessage"></p>
            </div>
            
            <!-- Панель "Сообщение не найдено" -->
            <div id="messagesNotFoundPanel" class="not-found-panel">
                <h3><i class="fas fa-search-minus"></i> Сообщение не найдено</h3>
                <p id="messagesNotFoundMessage"></p>
            </div>
            
            <!-- Контент будет загружаться сюда -->
            <div id="messagesContentContainer">
                <!-- Здесь будет отображаться загруженный контент -->
            </div>
        </div>
        
        <!-- Подвал -->
        <div class="footer">
            <p>Система мониторинга сообщений СЭДО | Тема: <span id="currentThemeName">Светлая</span></p>
        </div>
    </div>

    <script>
        // Функция для управления экраном загрузки
        function initLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingProgressBar = document.getElementById('loadingProgressBar');
            
            // Имитация прогресса загрузки
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) {
                    progress = 90;
                }
                loadingProgressBar.style.width = progress + '%';
            }, 200);
            
            // Скрытие экрана загрузки после полной загрузки страницы
            window.addEventListener('load', function() {
                clearInterval(progressInterval);
                loadingProgressBar.style.width = '100%';
                
                // Ждем немного, чтобы пользователь увидел завершение загрузки
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    
                    // Удаляем экран загрузки из DOM после завершения анимации
                    setTimeout(() => {
                        if (loadingScreen.parentNode) {
                            loadingScreen.parentNode.removeChild(loadingScreen);
                        }
                    }, 500);
                }, 500);
            });
            
            // На случай, если событие load не сработает, скрываем экран через 5 секунд
            setTimeout(() => {
                if (!loadingScreen.classList.contains('hidden')) {
                    clearInterval(progressInterval);
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        if (loadingScreen.parentNode) {
                            loadingScreen.parentNode.removeChild(loadingScreen);
                        }
                    }, 500);
                }
            }, 5000);
        }
        
        // Основной API сервер
        const MAIN_API_SERVER = 'https://monitor.sedo.keydisk.ru';
        const ASTRAL_API_SERVER = 'https://monitor.sedo.cloud.astral-dev.ru';
        
        // Режим работы приложения (true - использовать fallback-данные при ошибке)
        let USE_FALLBACK_MODE = false;

        // Конфигурация прокси
        const PROXY_CONFIG = {
            'direct': {
                name: 'Прямое подключение к API',
                format: '{}',
                testUrl: `${MAIN_API_SERVER}/message/f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3`
            },
            'corsproxy': {
                name: 'CORS Proxy',
                format: 'https://corsproxy.io/?{}',
                testUrl: `https://corsproxy.io/?${encodeURIComponent(`${MAIN_API_SERVER}/message/f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3`)}`
            },
            'allorigins': {
                name: 'AllOrigins',
                format: 'https://api.allorigins.win/raw?url={}',
                testUrl: `https://api.allorigins.win/raw?url=${encodeURIComponent(`${MAIN_API_SERVER}/message/f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3`)}`
            }
        };

        // Конфигурация поиска подписки
        const SUBSCRIPTION_CONFIG = {
            'inn': {
                name: 'Проверка подписки по ИНН',
                placeholder: 'Введите ИНН клиента (10 или 12 цифр)',
                path: '/subscription/inn/',
                example: '7712345678',
                validate: (value) => {
                    const cleaned = value.replace(/\D/g, '');
                    return cleaned.length === 10 || cleaned.length === 12;
                }
            },
            'regnum': {
                name: 'Проверка подписки по рег.номеру СФР',
                placeholder: 'Введите рег.номер клиента СФР',
                path: '/subscription/regnum/',
                example: '2322720573',
                validate: (value) => value.length >= 3
            }
        };

        // Конфигурация поиска сообщений
        const MESSAGES_CONFIG = {
            'message': {
                name: 'Поиск по ID сообщения',
                placeholder: 'Введите ID сообщения',
                needsDates: false,
                baseUrl: MAIN_API_SERVER,
                path: '/message/',
                example: 'f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3',
                validate: (value) => {
                    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    return uuidRegex.test(value) || value.length > 10;
                }
            },
            'clientRegNum': {
                name: 'Поиск по рег.номеру клиента СФР',
                placeholder: 'Введите рег.номер клиента СФР',
                needsDates: true,
                baseUrl: MAIN_API_SERVER,
                path: '/documents/client/regnum/',
                example: '123-456-789',
                limit: 50,
                validate: (value) => value.length >= 3
            },
            'clientGuid': {
                name: 'Поиск по GUID учетной записи клиента',
                placeholder: 'Введите GUID учетной записи клиента',
                needsDates: true,
                baseUrl: MAIN_API_SERVER,
                path: '/documents/client/guid/',
                example: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                limit: 50,
                validate: (value) => {
                    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    return uuidRegex.test(value);
                }
            },
            'clientInn': {
                name: 'Поиск по ИНН клиента',
                placeholder: 'Введите ИНН клиента',
                needsDates: true,
                baseUrl: MAIN_API_SERVER,
                path: '/documents/client/inn/',
                example: '7712345678',
                limit: 50,
                validate: (value) => {
                    const cleaned = value.replace(/\D/g, '');
                    return cleaned.length === 10 || cleaned.length === 12;
                }
            },
            'insurantRegNum': {
                name: 'Поиск по рег.номеру налогоплательщика в ФСС',
                placeholder: 'Введите рег.номер налогоплательщика в ФСС',
                needsDates: true,
                baseUrl: ASTRAL_API_SERVER,
                path: '/documents/insurant/regnum/',
                limit: 50,
                validate: (value) => value.length >= 3
            },
            'insurantInn': {
                name: 'Поиск по ИНН налогоплательщика',
                placeholder: 'Введите ИНН налогоплательщика',
                needsDates: true,
                baseUrl: ASTRAL_API_SERVER,
                path: '/documents/insurant/inn/',
                example: '7723456789',
                limit: 50,
                validate: (value) => {
                    const cleaned = value.replace(/\D/g, '');
                    return cleaned.length === 10;
                }
            }
        };

        // Конфигурация оптимизации
        const CACHE_CONFIG = {
            TTL: 5 * 60 * 1000,
            MAX_ITEMS: 100,
            ENABLED: true
        };

        const REQUEST_CONFIG = {
            MAX_RETRIES: 1,
            RETRY_DELAY: 1000,
            TIMEOUT: 10000,
            DEBOUNCE_DELAY: 500,
            RATE_LIMIT_DELAY: 500,
            MAX_REQUESTS_PER_MINUTE: 60
        };

        // Circuit Breaker конфигурация
        const CIRCUIT_BREAKER_CONFIG = {
            MAX_CONSECUTIVE_ERRORS: 2,
            OPEN_STATE_TIMEOUT: 30000,
            HEALTH_CHECK_INTERVAL: 15000
        };

        let serverHealth = {
            main: {
                consecutiveErrors: 0,
                state: 'CLOSED',
                lastErrorTime: null,
                halfOpenRequestSent: false
            },
            astral: {
                consecutiveErrors: 0,
                state: 'CLOSED',
                lastErrorTime: null,
                halfOpenRequestSent: false
            }
        };

        // Тестовые данные для fallback-режима
        const FALLBACK_DATA = {
            subscription: {
                status: 'ok',
                data: {
                    subscribed: true,
                    waiting: false,
                    docflow: [
                        {
                            id: 'test-doc-001',
                            title: 'Запрос на подписку оператора',
                            date: '2023-10-15T10:30:00Z'
                        },
                        {
                            id: 'test-doc-002',
                            title: 'Подтверждение подписки',
                            date: '2023-10-16T14:20:00Z'
                        }
                    ]
                }
            },
            message: {
                id: 'f5b23db7-2da0-4fa8-8fea-6c0b90bf93f3',
                date: '2023-10-20T09:15:00Z',
                type: 'Уведомление',
                received_at: '2023-10-20T09:20:00Z',
                processed_at: '2023-10-20T09:25:00Z',
                delivered_at: '2023-10-20T09:30:00Z',
                insurant: {
                    regnum: '123-456-789'
                },
                messages: [
                    {
                        id: 'msg-001',
                        title: 'Тестовое сообщение 1',
                        date: '2023-10-20T09:15:00Z',
                        type: 'Входящее',
                        received_at: '2023-10-20T09:20:00Z',
                        processed_at: '2023-10-20T09:25:00Z'
                    },
                    {
                        id: 'msg-002',
                        title: 'Тестовое сообщение 2',
                        date: '2023-10-19T14:30:00Z',
                        type: 'Исходящее',
                        received_at: '2023-10-19T14:35:00Z',
                        processed_at: '2023-10-19T14:40:00Z'
                    }
                ]
            },
            documents: [
                {
                    id: 'doc-test-001',
                    title: 'Расчет по страховым взносам',
                    date: '2023-10-18T00:00:00Z',
                    type: 'Отчетность',
                    status: 'Доставлено',
                    sender: 'ООО "Тестовая Компания"',
                    receiver: 'СФР России'
                },
                {
                    id: 'doc-test-002',
                    title: 'Уведомление о приеме',
                    date: '2023-10-17T00:00:00Z',
                    type: 'Уведомление',
                    status: 'Обработано',
                    sender: 'СФР России',
                    receiver: 'ООО "Тестовая Компания"'
                },
                {
                    id: 'doc-test-003',
                    title: 'Запрос документов',
                    date: '2023-10-16T00:00:00Z',
                    type: 'Запрос',
                    status: 'В обработке',
                    sender: 'СФР России',
                    receiver: 'ООО "Тестовая Компания"'
                }
            ]
        };

        // Предустановленные темы
        const THEMES = {
            'default': {
                name: 'Светлая',
                colors: {
                    'primary-color': '#2a5298',
                    'primary-dark': '#1e3c72',
                    'primary-light': '#4a90e2',
                    'secondary-color': '#ffb300',
                    'secondary-dark': '#ff8f00',
                    'background-color': '#f5f7fa',
                    'card-bg': '#ffffff',
                    'text-color': '#333333',
                    'text-light': '#666666',
                    'border-color': '#d1d9e6',
                    'success-color': '#1a8754',
                    'error-color': '#d32f2f',
                    'warning-color': '#ff9800',
                    'achievement-color': '#9c27b0'
                }
            },
            'dark': {
                name: 'Тёмная',
                colors: {
                    'primary-color': '#4a90e2',
                    'primary-dark': '#2a5298',
                    'primary-light': '#6eb0ff',
                    'secondary-color': '#ffb300',
                    'secondary-dark': '#ff8f00',
                    'background-color': '#121212',
                    'card-bg': '#1e1e1e',
                    'text-color': '#e0e0e0',
                    'text-light': '#aaaaaa',
                    'border-color': '#333333',
                    'success-color': '#4caf50',
                    'error-color': '#f44336',
                    'warning-color': '#ff9800',
                    'achievement-color': '#ba68c8'
                }
            },
            'green': {
                name: 'Зеленая',
                colors: {
                    'primary-color': '#1a8754',
                    'primary-dark': '#0d5c3a',
                    'primary-light': '#4caf50',
                    'secondary-color': '#8bc34a',
                    'secondary-dark': '#689f38',
                    'background-color': '#e8f5e9',
                    'card-bg': '#ffffff',
                    'text-color': '#1b5e20',
                    'text-light': '#4caf50',
                    'border-color': '#c8e6c9',
                    'success-color': '#2e7d32',
                    'error-color': '#c62828',
                    'warning-color': '#f9a825',
                    'achievement-color': '#7b1fa2'
                }
            },
            'orange': {
                name: 'Оранжевая',
                colors: {
                    'primary-color': '#f57c00',
                    'primary-dark': '#e65100',
                    'primary-light': '#ffb74d',
                    'secondary-color': '#ff9800',
                    'secondary-dark': '#f57c00',
                    'background-color': '#fff3e0',
                    'card-bg': '#ffffff',
                    'text-color': '#bf360c',
                    'text-light': '#ff9800',
                    'border-color': '#ffe0b2',
                    'success-color': '#689f38',
                    'error-color': '#d32f2f',
                    'warning-color': '#ffa000',
                    'achievement-color': '#7b1fa2'
                }
            },
            'pink': {
                name: 'Розовая',
                colors: {
                    'primary-color': '#e91e63',
                    'primary-dark': '#ad1457',
                    'primary-light': '#f48fb1',
                    'secondary-color': '#ec407a',
                    'secondary-dark': '#d81b60',
                    'background-color': '#fce4ec',
                    'card-bg': '#ffffff',
                    'text-color': '#880e4f',
                    'text-light': '#c2185b',
                    'border-color': '#f8bbd9',
                    'success-color': '#4caf50',
                    'error-color': '#f44336',
                    'warning-color': '#ff9800',
                    'achievement-color': '#9c27b0'
                }
            }
        };

        // Анимированные фоны
        const ACHIEVEMENT_BACKGROUNDS = {
            'bgLava': {
                id: 'bgLava',
                name: 'Эффект лавы',
                description: 'Плавные цветные шары, имитирующие лава-лампу',
                unlockRequirement: 'unlockAny',
                previewClass: 'bg-lava'
            }
        };

        // Система достижений
        const ACHIEVEMENTS = {
            'subscription_master': {
                id: 'subscription_master',
                name: 'Мастер проверок',
                description: 'Выполнить 10 проверок подписки',
                icon: 'fa-user-check',
                target: 10,
                type: 'subscription',
                backgroundReward: 'bgLava'
            },
            'message_explorer': {
                id: 'message_explorer',
                name: 'Исследователь сообщений',
                description: 'Найти 5 сообщений по ID',
                icon: 'fa-envelope',
                target: 5,
                type: 'message',
                backgroundReward: null
            },
            'client_analyst': {
                id: 'client_analyst',
                name: 'Аналитик клиентов',
                description: 'Выполнить 3 поиска по клиентам',
                icon: 'fa-users',
                target: 3,
                type: 'client',
                backgroundReward: null
            },
            'insurant_expert': {
                id: 'insurant_expert',
                name: 'Эксперт по налогоплательщикам',
                description: 'Выполнить 3 поиска по налогоплательщикам',
                icon: 'fa-building',
                target: 3,
                type: 'insurant',
                backgroundReward: null
            }
        };

        // Circuit Breaker функции
        function getServerFromUrl(url) {
            if (url.includes(MAIN_API_SERVER)) {
                return 'main';
            } else if (url.includes(ASTRAL_API_SERVER)) {
                return 'astral';
            } else {
                return null;
            }
        }

        function isServerAvailable(server) {
            if (!server) return true;

            const health = serverHealth[server];
            if (!health) return true;

            if (health.state === 'CLOSED') {
                return true;
            } else if (health.state === 'OPEN') {
                if (Date.now() - health.lastErrorTime > CIRCUIT_BREAKER_CONFIG.OPEN_STATE_TIMEOUT) {
                    health.state = 'HALF_OPEN';
                    health.halfOpenRequestSent = false;
                    return true;
                } else {
                    return false;
                }
            } else if (health.state === 'HALF_OPEN') {
                if (health.halfOpenRequestSent) {
                    return false;
                } else {
                    health.halfOpenRequestSent = true;
                    return true;
                }
            }
            return true;
        }

        function updateServerHealthOnSuccess(server) {
            if (!server) return;

            const health = serverHealth[server];
            if (health) {
                health.consecutiveErrors = 0;
                health.state = 'CLOSED';
                health.lastErrorTime = null;
                health.halfOpenRequestSent = false;
            }
        }

        function updateServerHealthOnError(server) {
            if (!server) return;

            const health = serverHealth[server];
            if (health) {
                health.consecutiveErrors++;
                health.lastErrorTime = Date.now();

                if (health.state === 'HALF_OPEN' || health.consecutiveErrors >= CIRCUIT_BREAKER_CONFIG.MAX_CONSECUTIVE_ERRORS) {
                    health.state = 'OPEN';
                }
                health.halfOpenRequestSent = false;
            }
        }

        function getFallbackData(requestType) {
            let fallbackData;
            
            if (requestType === 'subscription') {
                fallbackData = FALLBACK_DATA.subscription;
            } else if (requestType === 'message') {
                fallbackData = FALLBACK_DATA.message;
            } else if (requestType === 'documents') {
                fallbackData = FALLBACK_DATA.documents;
            } else {
                fallbackData = { status: 'error', message: 'Данные временно недоступны' };
            }
            
            return { data: fallbackData, source: 'fallback', isFallback: true };
        }

        // Класс для управления кэшем
        class RequestCache {
            constructor() {
                this.cache = new Map();
                this.loadFromStorage();
            }

            loadFromStorage() {
                try {
                    const savedCache = localStorage.getItem('sedoRequestCache');
                    if (savedCache) {
                        const parsed = JSON.parse(savedCache);
                        const now = Date.now();
                        
                        Object.entries(parsed).forEach(([key, value]) => {
                            if (now - value.timestamp < CACHE_CONFIG.TTL) {
                                this.cache.set(key, value);
                            }
                        });
                        
                        this.cleanup();
                    }
                } catch (e) {
                    console.error('Ошибка загрузки кэша:', e);
                }
            }

            saveToStorage() {
                try {
                    const cacheObj = Object.fromEntries(this.cache);
                    localStorage.setItem('sedoRequestCache', JSON.stringify(cacheObj));
                } catch (e) {
                    console.error('Ошибка сохранения кэша:', e);
                }
            }

            get(key) {
                if (!CACHE_CONFIG.ENABLED) return null;
                
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                const now = Date.now();
                if (now - cached.timestamp > CACHE_CONFIG.TTL) {
                    this.cache.delete(key);
                    this.saveToStorage();
                    return null;
                }
                
                return cached.data;
            }

            set(key, data) {
                if (!CACHE_CONFIG.ENABLED) return;
                
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
                
                this.cleanup();
                this.saveToStorage();
            }

            cleanup() {
                if (this.cache.size > CACHE_CONFIG.MAX_ITEMS) {
                    const entries = Array.from(this.cache.entries());
                    entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
                    
                    const toRemove = entries.slice(0, this.cache.size - CACHE_CONFIG.MAX_ITEMS);
                    toRemove.forEach(([key]) => this.cache.delete(key));
                }
            }

            clear() {
                this.cache.clear();
                localStorage.removeItem('sedoRequestCache');
            }

            delete(key) {
                this.cache.delete(key);
                this.saveToStorage();
            }
        }

        // Утилиты для дебаунсинга
        class Debouncer {
            constructor(delay) {
                this.delay = delay;
                this.timeout = null;
            }

            debounce(func) {
                return (...args) => {
                    clearTimeout(this.timeout);
                    this.timeout = setTimeout(() => func(...args), this.delay);
                };
            }

            cancel() {
                clearTimeout(this.timeout);
            }
        }

        // Утилита для форматирования URL
        function formatProxyUrl(proxyConfig, targetUrl) {
            if (proxyConfig.format.includes('{}')) {
                return proxyConfig.format.replace('{}', encodeURIComponent(targetUrl));
            } else if (proxyConfig.format.includes('?url=')) {
                return `${proxyConfig.format}${encodeURIComponent(targetUrl)}`;
            } else {
                return `${proxyConfig.format}${targetUrl}`;
            }
        }

        // Функция для проверки доступности сервера
        async function checkServerAvailability(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(url, {
                    method: 'HEAD',
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Оптимизированная функция с повторными попытками, кэшированием и fallback
        async function fetchWithRetryAndCache(url, options = {}, cacheKey = null, requestType = 'general', retryCount = REQUEST_CONFIG.MAX_RETRIES) {
            if (cacheKey) {
                const cached = requestCache.get(cacheKey);
                if (cached) {
                    return { data: cached, source: 'cache', isFallback: false };
                }
            }

            const server = getServerFromUrl(url);

            if (!isServerAvailable(server)) {
                return getFallbackData(requestType);
            }

            if (activeRequests.has(cacheKey)) {
                const result = await activeRequests.get(cacheKey);
                return result;
            }

            const requestPromise = (async () => {
                for (let i = 0; i <= retryCount; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), REQUEST_CONFIG.TIMEOUT);
                        
                        options.signal = controller.signal;
                        
                        const response = await fetch(url, options);
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        let data = await response.json();
                        
                        if (cacheKey) {
                            requestCache.set(cacheKey, data);
                        }

                        updateServerHealthOnSuccess(server);
                        
                        return { data: data, source: 'server', isFallback: false };
                        
                    } catch (error) {
                        if (i === retryCount) {
                            updateServerHealthOnError(server);
                            return getFallbackData(requestType);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, REQUEST_CONFIG.RETRY_DELAY));
                    }
                }
            })();

            activeRequests.set(cacheKey, requestPromise);
            
            try {
                const result = await requestPromise;
                return result;
            } finally {
                activeRequests.delete(cacheKey);
            }
        }

        // Оптимизированная функция загрузки подписки
        async function fetchSubscription(searchValue, subscriptionType, proxyType = null) {
            const proxyToUse = proxyType || currentSettings.proxy;
            const subscriptionConfig = SUBSCRIPTION_CONFIG[subscriptionType];
            
            if (!subscriptionConfig) throw new Error(`Неизвестный тип подписки: ${subscriptionType}`);
            
            const cleanedSearchValue = searchValue.replace(/\D/g, '');
            const targetUrl = `${MAIN_API_SERVER}${subscriptionConfig.path}${cleanedSearchValue}`;
            const proxyConfig = PROXY_CONFIG[proxyToUse];
            
            if (!proxyConfig) throw new Error(`Неизвестный прокси: ${proxyToUse}`);
            
            let url;
            if (proxyToUse === 'direct') {
                url = targetUrl;
            } else {
                url = formatProxyUrl(proxyConfig, targetUrl);
            }
            
            const cacheKey = generateCacheKey('subscription', {
                type: subscriptionType,
                value: cleanedSearchValue,
                proxy: proxyToUse
            });
            
            return fetchWithRetryAndCache(url, {
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'max-age=300'
                },
                mode: 'cors'
            }, cacheKey, 'subscription');
        }

        // Оптимизированная функция загрузки сообщений
        async function fetchMessages(searchValue, searchType, startDate = null, endDate = null, proxyType = null) {
            const proxyToUse = proxyType || currentSettings.proxy;
            const messagesConfig = MESSAGES_CONFIG[searchType];
            
            if (!messagesConfig) throw new Error(`Неизвестный тип поиска: ${searchType}`);
            
            let targetUrl;
            if (searchType === 'message') {
                targetUrl = `${messagesConfig.baseUrl}${messagesConfig.path}${searchValue}`;
            } else {
                if (!startDate || !endDate) throw new Error('Укажите обе даты');
                if (new Date(endDate) < new Date(startDate)) throw new Error('Дата окончания не может быть меньше даты начала');
                
                const limitParam = messagesConfig.limit ? `&limit=${messagesConfig.limit}` : '';
                targetUrl = `${messagesConfig.baseUrl}${messagesConfig.path}${searchValue}?start=${startDate}&end=${endDate}${limitParam}`;
            }
            
            const proxyConfig = PROXY_CONFIG[proxyToUse];
            
            if (!proxyConfig) throw new Error(`Неизвестный прокси: ${proxyToUse}`);
            
            let url;
            if (proxyToUse === 'direct') {
                url = targetUrl;
            } else {
                url = formatProxyUrl(proxyConfig, targetUrl);
            }
            
            const cacheKey = generateCacheKey('messages', {
                type: searchType,
                value: searchValue,
                startDate: startDate,
                endDate: endDate,
                proxy: proxyToUse
            });
            
            const requestType = searchType === 'message' ? 'message' : 'documents';
            return fetchWithRetryAndCache(url, {
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'max-age=300'
                },
                mode: 'cors'
            }, cacheKey, requestType);
        }

        // Текущие настройки
        let currentSettings = {
            theme: 'default',
            proxy: 'direct',
            currentTab: 'subscription',
            subscriptionType: 'inn',
            clientSearchType: 'clientRegNum',
            insurantSearchType: 'insurantRegNum',
            activeBackground: null,
            collapsedSections: {
                subsectionMessageId: false,
                subsectionClient: true,
                subsectionInsurant: true
            }
        };

        // Статистика и достижения
        let userStats = {
            subscriptionChecks: 0,
            messageSearches: 0,
            clientSearches: 0,
            insurantSearches: 0,
            unlockedAchievements: [],
            unlockedBackgrounds: []
        };

        // Инициализация кэша
        const requestCache = new RequestCache();
        const activeRequests = new Map();
        const debouncers = {
            subscription: new Debouncer(REQUEST_CONFIG.DEBOUNCE_DELAY),
            messageId: new Debouncer(REQUEST_CONFIG.DEBOUNCE_DELAY),
            client: new Debouncer(REQUEST_CONFIG.DEBOUNCE_DELAY),
            insurant: new Debouncer(REQUEST_CONFIG.DEBOUNCE_DELAY)
        };

        // Элементы DOM
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');
        const settingsIcon = document.getElementById('settingsIcon');
        const currentThemeName = document.getElementById('currentThemeName');
        const subscriptionTypeSelector = document.getElementById('subscriptionTypeSelector');
        const subscriptionInput = document.getElementById('subscriptionInput');
        const subscriptionButton = document.getElementById('subscriptionButton');
        const subscriptionLoadingIndicator = document.getElementById('subscriptionLoadingIndicator');
        const subscriptionErrorPanel = document.getElementById('subscriptionErrorPanel');
        const subscriptionErrorMessage = document.getElementById('subscriptionErrorMessage');
        const subscriptionResult = document.getElementById('subscriptionResult');
        
        const messageIdInput = document.getElementById('messageIdInput');
        const messageIdButton = document.getElementById('messageIdButton');
        
        const clientSearchTypeSelector = document.getElementById('clientSearchTypeSelector');
        const clientSearchInput = document.getElementById('clientSearchInput');
        const clientSearchButton = document.getElementById('clientSearchButton');
        const clientStartDate = document.getElementById('clientStartDate');
        const clientEndDate = document.getElementById('clientEndDate');
        
        const insurantSearchTypeSelector = document.getElementById('insurantSearchTypeSelector');
        const insurantSearchInput = document.getElementById('insurantSearchInput');
        const insurantSearchButton = document.getElementById('insurantSearchButton');
        const insurantStartDate = document.getElementById('insurantStartDate');
        const insurantEndDate = document.getElementById('insurantEndDate');
        
        const messagesLoadingIndicator = document.getElementById('messagesLoadingIndicator');
        const messagesErrorPanel = document.getElementById('messagesErrorPanel');
        const messagesErrorMessage = document.getElementById('messagesErrorMessage');
        const messagesNotFoundPanel = document.getElementById('messagesNotFoundPanel');
        const messagesNotFoundMessage = document.getElementById('messagesNotFoundMessage');
        const messagesContentContainer = document.getElementById('messagesContentContainer');
        
        const achievementNotification = document.getElementById('achievementNotification');
        const achievementNotificationTitle = document.getElementById('achievementNotificationTitle');
        const achievementNotificationDesc = document.getElementById('achievementNotificationDesc');
        const achievementsList = document.getElementById('achievementsList');
        const achievementsCount = document.getElementById('achievementsCount');
        const totalChecks = document.getElementById('totalChecks');
        const totalChecks2 = document.getElementById('totalChecks2');
        const achievementsProgress = document.getElementById('achievementsProgress');
        const backgroundSelector = document.getElementById('backgroundSelector');
        
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const subsections = document.querySelectorAll('.subsection');

        // Новые элементы для плавающей кнопки и модального окна
        const achievementsFloatBtn = document.getElementById('achievementsFloatBtn');
        const achievementsFloatBadge = document.getElementById('achievementsFloatBadge');
        const achievementsModal = document.getElementById('achievementsModal');
        const achievementsModalClose = document.getElementById('achievementsModalClose');

        // Элементы для контекстного меню
        const inputContextMenu = document.getElementById('inputContextMenu');

        // Элементы для автообновления
        const manualCheckUpdate = document.getElementById('manualCheckUpdate');
        const appVersion = document.getElementById('appVersion');

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация экрана загрузки
            initLoadingScreen();
            
            // Загрузка остальных компонентов
            loadSettings();
            loadUserStats();
            applyTheme(currentSettings.theme);
            setupEventListeners();
            setupTabs();
            setupSubscription();
            setupMessages();
            setDefaultDates();
            setupCollapsibleSections();
            updateStatsDisplay();
            renderAchievements();
            updateBackgroundSelector();
            applyActiveBackground();
            
            setupAnimationOptimization();
            
            // Настройка плавающей кнопки и модального окна
            setupAchievementsButton();
            
            // Настройка контекстного меню для полей ввода
            setupInputContextMenu();
            
            // Проверка доступности сервера при загрузке
            checkInitialConnection();
            
            // Запускаем периодическую проверку здоровья серверов
            startHealthChecks();
        });

        // Настройка контекстного меню для полей ввода
        function setupInputContextMenu() {
            let currentInput = null;
            
            // Список полей ввода, для которых нужно контекстное меню
            const inputSelectors = [
                '#subscriptionInput',
                '#messageIdInput',
                '#clientSearchInput',
                '#insurantSearchInput'
            ];
            
            // Добавляем обработчики ко всем полям ввода
            inputSelectors.forEach(selector => {
                const input = document.querySelector(selector);
                if (input) {
                    // Отключаем стандартное контекстное меню
                    input.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        currentInput = this;
                        
                        // Позиционируем меню рядом с курсором
                        const x = e.pageX;
                        const y = e.pageY;
                        
                        inputContextMenu.style.left = x + 'px';
                        inputContextMenu.style.top = y + 'px';
                        inputContextMenu.classList.add('active');
                        
                        // Обновляем доступность пунктов меню
                        updateContextMenuItems();
                    });
                    
                    // Скрываем меню при клике в поле ввода
                    input.addEventListener('click', function() {
                        inputContextMenu.classList.remove('active');
                    });
                    
                    // Обработчики для специальных клавиш
                    input.addEventListener('keydown', function(e) {
                        if (e.ctrlKey || e.metaKey) {
                            switch(e.key.toLowerCase()) {
                                case 'a':
                                    e.preventDefault();
                                    this.select();
                                    break;
                                case 'c':
                                    copyTextFromInput(this);
                                    break;
                                case 'x':
                                    cutTextFromInput(this);
                                    break;
                                case 'v':
                                    // Браузер сам вставит текст
                                    break;
                            }
                        }
                    });
                }
            });
            
            // Закрытие меню при клике в другом месте
            document.addEventListener('click', function(e) {
                if (!inputContextMenu.contains(e.target)) {
                    inputContextMenu.classList.remove('active');
                }
            });
            
            // Закрытие меню по ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    inputContextMenu.classList.remove('active');
                }
            });
            
            // Обработчики для пунктов меню
            inputContextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    if (!currentInput) return;
                    
                    const action = this.dataset.action;
                    
                    switch(action) {
                        case 'cut':
                            cutTextFromInput(currentInput);
                            break;
                        case 'copy':
                            copyTextFromInput(currentInput);
                            break;
                        case 'paste':
                            pasteTextToInput(currentInput);
                            break;
                        case 'selectAll':
                            currentInput.select();
                            break;
                        case 'clear':
                            currentInput.value = '';
                            // Вызываем событие input для обновления состояния
                            currentInput.dispatchEvent(new Event('input', { bubbles: true }));
                            break;
                    }
                    
                    // Скрываем меню после действия
                    inputContextMenu.classList.remove('active');
                });
            });
            
            // Обновление состояния пунктов меню
            function updateContextMenuItems() {
                if (!currentInput) return;
                
                const hasText = currentInput.value.length > 0;
                const hasSelection = currentInput.selectionStart !== currentInput.selectionEnd;
                
                // Включение/выключение пунктов меню
                const cutItem = inputContextMenu.querySelector('[data-action="cut"]');
                const copyItem = inputContextMenu.querySelector('[data-action="copy"]');
                const clearItem = inputContextMenu.querySelector('[data-action="clear"]');
                
                if (cutItem) cutItem.style.opacity = hasSelection ? '1' : '0.5';
                if (copyItem) copyItem.style.opacity = hasSelection ? '1' : '0.5';
                if (clearItem) clearItem.style.opacity = hasText ? '1' : '0.5';
            }
            
            // Функция вырезания текста
            function cutTextFromInput(input) {
                if (input.selectionStart === input.selectionEnd) return;
                
                const selectedText = input.value.substring(input.selectionStart, input.selectionEnd);
                
                // Копируем в буфер обмена
                navigator.clipboard.writeText(selectedText).then(() => {
                    // Удаляем выделенный текст
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    input.value = input.value.substring(0, start) + input.value.substring(end);
                    
                    // Устанавливаем курсор на место удаленного текста
                    input.selectionStart = input.selectionEnd = start;
                    
                    // Вызываем событие input для обновления состояния
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Показываем уведомление
                    showMessage('Текст вырезан', 'Текст скопирован в буфер обмена и удален из поля', 'success');
                }).catch(err => {
                    console.error('Ошибка при вырезании текста:', err);
                    showMessage('Ошибка', 'Не удалось вырезать текст', 'error');
                });
            }
            
            // Функция копирования текста
            function copyTextFromInput(input) {
                let textToCopy;
                
                if (input.selectionStart !== input.selectionEnd) {
                    // Копируем выделенный текст
                    textToCopy = input.value.substring(input.selectionStart, input.selectionEnd);
                } else {
                    // Копируем весь текст
                    textToCopy = input.value;
                }
                
                if (!textToCopy) return;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Показываем визуальную обратную связь
                    const originalBg = input.style.backgroundColor;
                    input.classList.add('copied');
                    
                    setTimeout(() => {
                        input.classList.remove('copied');
                    }, 300);
                    
                    showMessage('Текст скопирован', 'Текст успешно скопирован в буфер обмена', 'success');
                }).catch(err => {
                    console.error('Ошибка при копировании текста:', err);
                    showMessage('Ошибка', 'Не удалось скопировать текст', 'error');
                });
            }
            
            // Функция вставки текста
            async function pasteTextToInput(input) {
                try {
                    const text = await navigator.clipboard.readText();
                    
                    if (!text) return;
                    
                    const start = input.selectionStart;
                    const end = input.selectionEnd;
                    
                    // Вставляем текст на место выделения
                    input.value = input.value.substring(0, start) + text + input.value.substring(end);
                    
                    // Устанавливаем курсор после вставленного текста
                    input.selectionStart = input.selectionEnd = start + text.length;
                    
                    // Вызываем событие input для обновления состояния
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // Показываем визуальную обратную связь
                    input.classList.add('pasted');
                    
                    setTimeout(() => {
                        input.classList.remove('pasted');
                    }, 300);
                    
                } catch (err) {
                    console.error('Ошибка при вставке текста:', err);
                    showMessage('Ошибка', 'Не удалось вставить текст. Возможно, буфер обмена пуст или нет прав доступа.', 'error');
                }
            }
            
            // Также добавляем обработчики для всех полей ввода на странице
            document.querySelectorAll('input[type="text"], textarea').forEach(input => {
                if (!input.classList.contains('search-input') && !inputSelectors.includes('#' + input.id)) {
                    input.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        currentInput = this;
                        
                        const x = e.pageX;
                        const y = e.pageY;
                        
                        inputContextMenu.style.left = x + 'px';
                        inputContextMenu.style.top = y + 'px';
                        inputContextMenu.classList.add('active');
                        updateContextMenuItems();
                    });
                }
            });
        }

        // Настройка плавающей кнопки достижений
        function setupAchievementsButton() {
            achievementsFloatBtn.addEventListener('click', function() {
                openAchievementsModal();
            });
            
            achievementsModalClose.addEventListener('click', function() {
                closeAchievementsModal();
            });
            
            // Закрытие модального окна при клике вне его
            achievementsModal.addEventListener('click', function(event) {
                if (event.target === achievementsModal) {
                    closeAchievementsModal();
                }
            });
            
            // Закрытие по ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && achievementsModal.classList.contains('active')) {
                    closeAchievementsModal();
                }
            });
        }

        function openAchievementsModal() {
            achievementsModal.classList.add('active');
            renderAchievements();
            document.body.style.overflow = 'hidden';
        }

        function closeAchievementsModal() {
            achievementsModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Периодическая проверка здоровья серверов
        function startHealthChecks() {
            setInterval(async () => {
                // Проверяем только серверы в состоянии OPEN
                if (serverHealth.main.state === 'OPEN') {
                    const isAvailable = await checkServerAvailability(`${MAIN_API_SERVER}/health`);
                    if (isAvailable) {
                        serverHealth.main.state = 'CLOSED';
                        serverHealth.main.consecutiveErrors = 0;
                    }
                }
                
                if (serverHealth.astral.state === 'OPEN') {
                    const isAvailable = await checkServerAvailability(`${ASTRAL_API_SERVER}/health`);
                    if (isAvailable) {
                        serverHealth.astral.state = 'CLOSED';
                        serverHealth.astral.consecutiveErrors = 0;
                    }
                }
            }, CIRCUIT_BREAKER_CONFIG.HEALTH_CHECK_INTERVAL);
        }

        // Проверка начального соединения
        async function checkInitialConnection() {
            const isAvailable = await checkServerAvailability(`${MAIN_API_SERVER}/health`);
            
            if (!isAvailable) {
                showConnectionWarning();
            }
        }

        // Показать предупреждение о проблемах с соединением
        function showConnectionWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'message-notification warning';
            warningDiv.innerHTML = `
                <h4 style="margin-bottom: 5px; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Данный загружаются</h4>
                <p style="margin-bottom: 10px;">Пожалуйста подождите идет подключение к API.</p>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="tryAgainBtn" style="
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        <i class="fas fa-redo"></i> Попробовать снова
                    </button>
                    <button id="useDemoBtn" style="
                        background: var(--secondary-color);
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    ">
                        <i class="fas fa-eye"></i> Использовать демо-данные
                    </button>
                </div>
            `;
            
            document.body.appendChild(warningDiv);
            
            document.getElementById('tryAgainBtn').addEventListener('click', async () => {
                warningDiv.remove();
                const isAvailable = await checkServerAvailability(`${MAIN_API_SERVER}/health`);
                if (!isAvailable) {
                    showConnectionWarning();
                }
            });
            
            document.getElementById('useDemoBtn').addEventListener('click', () => {
                USE_FALLBACK_MODE = true;
                warningDiv.innerHTML = `
                    <h4 style="margin-bottom: 5px; font-weight: 600;"><i class="fas fa-info-circle"></i> Режим демонстрации</h4>
                    <p>Используются тестовые данные. Для получения реальных данных проверьте подключение.</p>
                `;
                
                setTimeout(() => {
                    warningDiv.style.opacity = '0';
                    setTimeout(() => warningDiv.remove(), 300);
                }, 5000);
            });
            
            setTimeout(() => {
                warningDiv.style.opacity = '0';
                setTimeout(() => warningDiv.remove(), 300);
            }, 15000);
        }

        // Функция для отображения сообщений
        function showMessage(title, text, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-notification ${type}`;
            
            messageDiv.innerHTML = `
                <h4 style="margin-bottom: 5px; font-weight: 600;">${title}</h4>
                <p style="margin: 0; opacity: 0.9;">${text}</p>
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 5000);
        }

        // Загрузка настроек из localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('sedoMonitorSettings');
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);
                    
                    delete parsed.subscriptionSearch;
                    delete parsed.messageIdSearch;
                    delete parsed.clientSearch;
                    delete parsed.insurantSearch;
                    
                    currentSettings = { ...currentSettings, ...parsed };
                } catch (e) {
                    console.error('Ошибка загрузки настроек:', e);
                }
            }
        }

        function loadUserStats() {
            const savedStats = localStorage.getItem('sedoMonitorStats');
            if (savedStats) {
                try {
                    userStats = JSON.parse(savedStats);
                    
                    if (!userStats.unlockedBackgrounds) {
                        userStats.unlockedBackgrounds = [];
                    }
                } catch (e) {
                    console.error('Ошибка загрузки статистики:', e);
                    resetUserStats();
                }
            } else {
                resetUserStats();
            }
        }

        function resetUserStats() {
            userStats = {
                subscriptionChecks: 0,
                messageSearches: 0,
                clientSearches: 0,
                insurantSearches: 0,
                unlockedAchievements: [],
                unlockedBackgrounds: []
            };
            saveUserStats();
        }

        function saveUserStats() {
            localStorage.setItem('sedoMonitorStats', JSON.stringify(userStats));
        }

        function saveSettings() {
            localStorage.setItem('sedoMonitorSettings', JSON.stringify(currentSettings));
        }

        function setupCollapsibleSections() {
            subsections.forEach(subsection => {
                const header = subsection.querySelector('.subsection-header');
                const content = subsection.querySelector('.subsection-content');
                const toggleIcon = subsection.querySelector('.subsection-toggle');
                const subsectionId = subsection.id;
                
                if (currentSettings.collapsedSections && currentSettings.collapsedSections[subsectionId]) {
                    header.classList.remove('active');
                    content.classList.remove('active');
                }
                
                header.addEventListener('click', function() {
                    const isActive = this.classList.contains('active');
                    
                    this.classList.toggle('active');
                    content.classList.toggle('active');
                    
                    if (currentSettings.collapsedSections) {
                        currentSettings.collapsedSections[subsectionId] = !isActive;
                        saveSettings();
                    }
                });
            });
        }

        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    currentSettings.currentTab = tabId;
                    saveSettings();
                });
            });
            
            const activeTab = document.querySelector(`.tab[data-tab="${currentSettings.currentTab}"]`);
            if (activeTab) {
                activeTab.click();
            }
        }

        function setupSubscription() {
            const subscriptionTypeButtons = subscriptionTypeSelector.querySelectorAll('.search-type-btn');
            
            subscriptionTypeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    subscriptionTypeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const subscriptionType = this.dataset.type;
                    currentSettings.subscriptionType = subscriptionType;
                    saveSettings();
                    
                    updateSubscriptionInterface(subscriptionType);
                });
            });
            
            const debouncedCheck = debouncers.subscription.debounce(() => {
                if (subscriptionInput.value.trim()) {
                    performSubscriptionCheck();
                }
            });
            
            subscriptionButton.addEventListener('click', debouncedCheck);
            
            subscriptionInput.addEventListener('input', debouncedCheck);
            subscriptionInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    debouncers.subscription.cancel();
                    performSubscriptionCheck();
                }
            });
            
            updateSubscriptionInterface(currentSettings.subscriptionType);
            subscriptionInput.value = '';
        }

        function updateSubscriptionInterface(subscriptionType) {
            const config = SUBSCRIPTION_CONFIG[subscriptionType];
            
            if (!config) return;
            
            subscriptionInput.placeholder = config.placeholder;
            
            const buttons = subscriptionTypeSelector.querySelectorAll('.search-type-btn');
            buttons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.type === subscriptionType) {
                    button.classList.add('active');
                }
            });
        }

        function setupMessages() {
            const debouncedMessageSearch = debouncers.messageId.debounce(() => {
                if (messageIdInput.value.trim()) {
                    performMessageIdSearch();
                }
            });
            
            messageIdButton.addEventListener('click', debouncedMessageSearch);
            
            messageIdInput.addEventListener('input', debouncedMessageSearch);
            messageIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    debouncers.messageId.cancel();
                    performMessageIdSearch();
                }
            });
            
            messageIdInput.value = '';
            
            const clientSearchTypeButtons = clientSearchTypeSelector.querySelectorAll('.search-type-btn');
            clientSearchTypeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    clientSearchTypeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const searchType = this.dataset.type;
                    currentSettings.clientSearchType = searchType;
                    saveSettings();
                    
                    updateClientSearchInterface(searchType);
                });
            });
            
            const debouncedClientSearch = debouncers.client.debounce(() => {
                if (clientSearchInput.value.trim()) {
                    performClientSearch();
                }
            });
            
            clientSearchButton.addEventListener('click', debouncedClientSearch);
            
            clientSearchInput.addEventListener('input', debouncedClientSearch);
            clientSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    debouncers.client.cancel();
                    performClientSearch();
                }
            });
            
            clientSearchInput.value = '';
            
            const insurantSearchTypeButtons = insurantSearchTypeSelector.querySelectorAll('.search-type-btn');
            insurantSearchTypeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    insurantSearchTypeButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    const searchType = this.dataset.type;
                    currentSettings.insurantSearchType = searchType;
                    saveSettings();
                    
                    updateInsurantSearchInterface(searchType);
                });
            });
            
            const debouncedInsurantSearch = debouncers.insurant.debounce(() => {
                if (insurantSearchInput.value.trim()) {
                    performInsurantSearch();
                }
            });
            
            insurantSearchButton.addEventListener('click', debouncedInsurantSearch);
            
            insurantSearchInput.addEventListener('input', debouncedInsurantSearch);
            insurantSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    debouncers.insurant.cancel();
                    performInsurantSearch();
                }
            });
            
            insurantSearchInput.value = '';
            
            updateClientSearchInterface(currentSettings.clientSearchType);
            updateInsurantSearchInterface(currentSettings.insurantSearchType);
        }

        function updateClientSearchInterface(searchType) {
            const config = MESSAGES_CONFIG[searchType];
            
            if (!config) return;
            
            clientSearchInput.placeholder = config.placeholder;
            
            const buttons = clientSearchTypeSelector.querySelectorAll('.search-type-btn');
            buttons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.type === searchType) {
                    button.classList.add('active');
                }
            });
        }

        function updateInsurantSearchInterface(searchType) {
            const config = MESSAGES_CONFIG[searchType];
            
            if (!config) return;
            
            insurantSearchInput.placeholder = config.placeholder;
            
            const buttons = insurantSearchTypeSelector.querySelectorAll('.search-type-btn');
            buttons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.type === searchType) {
                    button.classList.add('active');
                }
            });
        }

        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);
            
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            clientStartDate.value = formatDate(weekAgo);
            clientEndDate.value = formatDate(today);
            
            insurantStartDate.value = formatDate(weekAgo);
            insurantEndDate.value = formatDate(today);
        }

        function applyTheme(themeName) {
            document.body.classList.remove('theme-default', 'theme-dark', 'theme-blue', 'theme-green', 'theme-orange', 'theme-pink');
            
            if (themeName !== 'default') {
                document.body.classList.add(`theme-${themeName}`);
            }
            
            const theme = THEMES[themeName];
            if (theme && theme.colors) {
                Object.entries(theme.colors).forEach(([variable, color]) => {
                    document.documentElement.style.setProperty(`--${variable}`, color);
                });
            }
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.theme === themeName) {
                    option.classList.add('active');
                }
            });
            
            currentThemeName.textContent = THEMES[themeName]?.name || 'Светлая';
            currentSettings.theme = themeName;
            saveSettings();
        }

        function setupEventListeners() {
            settingsToggle.addEventListener('click', function() {
                settingsContent.classList.toggle('active');
                if (settingsContent.classList.contains('active')) {
                    settingsIcon.innerHTML = '<i class="fas fa-chevron-up"></i>';
                } else {
                    settingsIcon.innerHTML = '<i class="fas fa-chevron-down"></i>';
                }
            });

            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    applyTheme(theme);
                });
            });
        }

        function updateStatsDisplay() {
            const total = userStats.subscriptionChecks + userStats.messageSearches + 
                         userStats.clientSearches + userStats.insurantSearches;
            
            totalChecks.textContent = total;
            totalChecks2.textContent = total;
            
            const unlockedCount = userStats.unlockedAchievements.length;
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            achievementsCount.textContent = `${unlockedCount}/${totalAchievements}`;
            achievementsFloatBadge.textContent = unlockedCount;
            
            const progress = Math.round((unlockedCount / totalAchievements) * 100);
            achievementsProgress.textContent = `${progress}%`;
        }

        function checkAchievements() {
            const achievementsToCheck = [
                { id: 'subscription_master', count: userStats.subscriptionChecks },
                { id: 'message_explorer', count: userStats.messageSearches },
                { id: 'client_analyst', count: userStats.clientSearches },
                { id: 'insurant_expert', count: userStats.insurantSearches }
            ];
            
            let newAchievements = [];
            
            achievementsToCheck.forEach(check => {
                const achievement = ACHIEVEMENTS[check.id];
                if (achievement && check.count >= achievement.target) {
                    if (!userStats.unlockedAchievements.includes(check.id)) {
                        userStats.unlockedAchievements.push(check.id);
                        newAchievements.push(achievement);
                        
                        // Разблокируем фон если есть награда
                        if (achievement.backgroundReward && !userStats.unlockedBackgrounds.includes(achievement.backgroundReward)) {
                            userStats.unlockedBackgrounds.push(achievement.backgroundReward);
                        }
                    }
                }
            });
            
            saveUserStats();
            
            newAchievements.forEach((achievement, index) => {
                setTimeout(() => {
                    showAchievementNotification(achievement);
                }, index * 3000);
            });
            
            updateStatsDisplay();
            updateBackgroundSelector();
            
            if (achievementsModal.classList.contains('active')) {
                renderAchievements();
            }
        }

        function showAchievementNotification(achievement) {
            achievementNotificationTitle.textContent = achievement.name;
            achievementNotificationDesc.textContent = achievement.description;
            
            achievementNotification.classList.add('active');
            
            setTimeout(() => {
                achievementNotification.classList.remove('active');
            }, 5000);
        }

        function updateBackgroundSelector() {
            if (!backgroundSelector) return;
            
            const unlockedCount = userStats.unlockedBackgrounds.length;
            
            if (unlockedCount === 0) {
                return;
            }
            
            let html = '';
            
            html += `
                <div class="theme-option ${!currentSettings.activeBackground ? 'active' : ''}" data-background="none">
                    <div class="background-preview" style="background: var(--background-color);">
                        <div class="background-name">Без фона</div>
                    </div>
                    <div>Без фона</div>
                </div>
            `;
            
            userStats.unlockedBackgrounds.forEach(bgId => {
                const background = ACHIEVEMENT_BACKGROUNDS[bgId];
                if (background) {
                    const isActive = currentSettings.activeBackground === bgId;
                    html += `
                        <div class="theme-option ${isActive ? 'active' : ''}" data-background="${bgId}">
                            <div class="background-preview ${background.previewClass}">
                                <div class="background-name">${background.name}</div>
                            </div>
                            <div>${background.name}</div>
                        </div>
                    `;
                }
            });
            
            backgroundSelector.innerHTML = html;
            
            backgroundSelector.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const bgId = this.dataset.background;
                    
                    if (bgId === 'none') {
                        deactivateAllBackgrounds();
                        currentSettings.activeBackground = null;
                    } else {
                        deactivateAllBackgrounds();
                        activateBackground(bgId);
                        currentSettings.activeBackground = bgId;
                    }
                    
                    backgroundSelector.querySelectorAll('.theme-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    saveSettings();
                });
            });
        }

        function activateBackground(bgId) {
            const backgroundElement = document.getElementById(bgId);
            if (backgroundElement) {
                backgroundElement.classList.add('active');
                
                if (bgId === 'bgLava') {
                    createLavaBubbles();
                }
            }
        }

        function deactivateAllBackgrounds() {
            Object.keys(ACHIEVEMENT_BACKGROUNDS).forEach(bgId => {
                const backgroundElement = document.getElementById(bgId);
                if (backgroundElement) {
                    backgroundElement.classList.remove('active');
                    
                    if (bgId === 'bgLava') {
                        const bubbles = backgroundElement.querySelectorAll('.lava-bubble');
                        bubbles.forEach(bubble => bubble.remove());
                    }
                }
            });
        }

        function applyActiveBackground() {
            if (currentSettings.activeBackground) {
                activateBackground(currentSettings.activeBackground);
            }
        }

        function createLavaBubbles() {
            const lavaContainer = document.getElementById('bgLava');
            if (!lavaContainer || !lavaContainer.classList.contains('active')) {
                return;
            }
            
            const oldBubbles = lavaContainer.querySelectorAll('.lava-bubble');
            oldBubbles.forEach(bubble => bubble.remove());
            
            const bubbleCount = 10;
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = document.createElement('div');
                bubble.classList.add('lava-bubble');
                
                const size = Math.random() * 15 + 5;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.bottom = '-20px';
                
                bubble.style.opacity = Math.random() * 0.4 + 0.2;
                
                const colors = [
                    'rgba(255, 107, 107, 0.4)',
                    'rgba(78, 205, 196, 0.4)',
                    'rgba(255, 209, 102, 0.4)',
                    'rgba(157, 78, 221, 0.4)',
                    'rgba(0, 187, 249, 0.4)'
                ];
                bubble.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                bubble.style.animationDelay = `${Math.random() * 5}s`;
                bubble.style.animationDuration = `${Math.random() * 10 + 10}s`;
                
                lavaContainer.appendChild(bubble);
            }
        }

        function renderAchievements() {
            let html = '';
            
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                const isUnlocked = userStats.unlockedAchievements.includes(achievement.id);
                let currentCount = 0;
                
                switch(achievement.type) {
                    case 'subscription':
                        currentCount = userStats.subscriptionChecks;
                        break;
                    case 'message':
                        currentCount = userStats.messageSearches;
                        break;
                    case 'client':
                        currentCount = userStats.clientSearches;
                        break;
                    case 'insurant':
                        currentCount = userStats.insurantSearches;
                        break;
                }
                
                const progress = Math.min(currentCount, achievement.target);
                const progressPercent = Math.round((progress / achievement.target) * 100);
                
                html += `
                    <div class="achievement-card ${isUnlocked ? '' : 'locked'}">
                        <div class="achievement-badge ${isUnlocked ? '' : 'locked'}">
                            <i class="fas ${achievement.icon}"></i>
                        </div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-description">${achievement.description}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="achievement-progress-text">
                                ${isUnlocked ? 
                                    '<i class="fas fa-check-circle" style="color: var(--success-color);"></i> Получено!' : 
                                    `${progress}/${achievement.target} (${progressPercent}%)`}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            achievementsList.innerHTML = html;
        }

        function incrementSubscriptionCount() {
            userStats.subscriptionChecks++;
            saveUserStats();
            checkAchievements();
            updateStatsDisplay();
        }

        function incrementMessageCount() {
            userStats.messageSearches++;
            saveUserStats();
            checkAchievements();
            updateStatsDisplay();
        }

        function incrementClientCount() {
            userStats.clientSearches++;
            saveUserStats();
            checkAchievements();
            updateStatsDisplay();
        }

        function incrementInsurantCount() {
            userStats.insurantSearches++;
            saveUserStats();
            checkAchievements();
            updateStatsDisplay();
        }

        function performSubscriptionCheck() {
            const searchValue = subscriptionInput.value.trim();
            if (!searchValue) {
                showSubscriptionError('Введите значение для проверки подписки');
                return;
            }

            checkSubscription(searchValue, currentSettings.subscriptionType);
        }

        function performMessageIdSearch() {
            const searchValue = messageIdInput.value.trim();
            if (!searchValue) {
                showMessagesError('Введите ID сообщения для поиска');
                return;
            }

            loadMessagesData(searchValue, 'message');
        }

        function performClientSearch() {
            const searchValue = clientSearchInput.value.trim();
            const searchType = currentSettings.clientSearchType;
            const startDate = clientStartDate.value;
            const endDate = clientEndDate.value;
            
            if (!searchValue) {
                showMessagesError('Введите значение для поиска');
                return;
            }

            const config = MESSAGES_CONFIG[searchType];
            if (config.needsDates) {
                if (!startDate || !endDate) {
                    showMessagesError('Укажите обе даты');
                    return;
                }

                if (new Date(endDate) < new Date(startDate)) {
                    showMessagesError('Дата окончания не может быть меньше даты начала');
                    return;
                }
            }
            
            loadMessagesData(searchValue, searchType, startDate, endDate);
        }

        function performInsurantSearch() {
            const searchValue = insurantSearchInput.value.trim();
            const searchType = currentSettings.insurantSearchType;
            const startDate = insurantStartDate.value;
            const endDate = insurantEndDate.value;
            
            if (!searchValue) {
                showMessagesError('Введите значение для поиска');
                return;
            }

            const config = MESSAGES_CONFIG[searchType];
            if (config.needsDates) {
                if (!startDate || !endDate) {
                    showMessagesError('Укажите обе даты');
                    return;
                }

                if (new Date(endDate) < new Date(startDate)) {
                    showMessagesError('Дата окончания не может быть меньше даты начала');
                    return;
                }
            }
            
            loadMessagesData(searchValue, searchType, startDate, endDate);
        }

        async function checkSubscription(searchValue, subscriptionType) {
            subscriptionLoadingIndicator.classList.add('active');
            subscriptionErrorPanel.classList.remove('active');
            subscriptionResult.classList.remove('active');
            subscriptionResult.innerHTML = '';

            subscriptionButton.disabled = true;
            subscriptionButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Проверяем...';

            try {
                const result = await fetchSubscription(searchValue, subscriptionType);
                
                // Показываем источник данных
                const dataSourceBadge = result.isFallback ? 
                    '<span class="status-warning" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-eye"></i> Демо-данные</span>' : 
                    '<span class="status-success" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-server"></i> Онлайн</span>';
                
                renderSubscriptionResult(result.data, searchValue, subscriptionType, dataSourceBadge);
                
                if (!result.isFallback) {
                    incrementSubscriptionCount();
                }
                
            } catch (error) {
                let errorMessage = error.message;
                if (error.message.includes('timeout') || error.message.includes('time out')) {
                    errorMessage = 'Превышено время ожидания ответа от сервера. Попробуйте позже.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Не удалось подключиться к серверу. Проверьте интернет-соединение.';
                }
                
                showSubscriptionError(`Ошибка проверки подписки: ${errorMessage}`);
                showMessage('Ошибка проверки', errorMessage, 'error');
                
            } finally {
                subscriptionLoadingIndicator.classList.remove('active');
                subscriptionButton.disabled = false;
                subscriptionButton.innerHTML = '<i class="fas fa-search"></i> Проверить';
            }
        }

        async function loadMessagesData(searchValue, searchType, startDate = null, endDate = null) {
            messagesLoadingIndicator.classList.add('active');
            messagesErrorPanel.classList.remove('active');
            messagesNotFoundPanel.classList.remove('active');
            messagesContentContainer.innerHTML = '';
            
            let searchButton;
            if (searchType === 'message') {
                searchButton = messageIdButton;
            } else if (searchType.startsWith('client')) {
                searchButton = clientSearchButton;
            } else if (searchType.startsWith('insurant')) {
                searchButton = insurantSearchButton;
            }
            
            if (searchButton) {
                const originalText = searchButton.innerHTML;
                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Поиск...';
                
                setTimeout(() => {
                    if (searchButton) {
                        searchButton.disabled = false;
                        searchButton.innerHTML = originalText;
                    }
                }, 1000);
            }

            try {
                const config = MESSAGES_CONFIG[searchType];
                if (config.validate && !config.validate(searchValue)) {
                    throw new Error(`Некорректный формат для ${config.name}. Пример: ${config.example}`);
                }
                
                const result = await fetchMessages(searchValue, searchType, startDate, endDate);
                
                if (searchType === 'message') {
                    if (!result.data || (typeof result.data === 'object' && Object.keys(result.data).length === 0)) {
                        showMessagesNotFound(searchValue, searchType);
                        return;
                    }
                    renderMessageData(result.data, result.isFallback);
                } else {
                    renderDocumentsData(result.data, searchType, searchValue, startDate, endDate, result.isFallback);
                }
                
                if (!result.isFallback) {
                    if (searchType === 'message') {
                        incrementMessageCount();
                    } else if (searchType.startsWith('client')) {
                        incrementClientCount();
                    } else if (searchType.startsWith('insurant')) {
                        incrementInsurantCount();
                    }
                }
                
            } catch (error) {
                let errorMessage = error.message;
                if (error.message.includes('timeout') || error.message.includes('time out')) {
                    errorMessage = 'Превышено время ожидания ответа от сервера. Попробуйте позже.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Не удалось подключиться к серверу. Проверьте интернет-соединение.';
                } else if (error.message.includes('404') || error.message.includes('Not Found')) {
                    showMessagesNotFound(searchValue, searchType);
                    return;
                }
                
                showMessagesError(`Ошибка загрузки данных: ${errorMessage}`);
                showMessage('Ошибка поиска', errorMessage, 'error');
                
            } finally {
                messagesLoadingIndicator.classList.remove('active');
            }
        }

        function showSubscriptionError(message) {
            subscriptionErrorMessage.innerHTML = message;
            subscriptionErrorPanel.classList.add('active');
            subscriptionResult.classList.remove('active');
        }

        function renderSubscriptionResult(data, searchValue, subscriptionType, dataSourceBadge = '') {
            const config = SUBSCRIPTION_CONFIG[subscriptionType];
            
            let subscribed = false;
            let waiting = false;
            let status = 'unknown';
            let docflow = [];
            
            if (data && data.status === 'ok' && data.data) {
                status = data.status;
                subscribed = data.data.subscribed || false;
                waiting = data.data.waiting || false;
                docflow = data.data.docflow || [];
            } else if (data && data.status) {
                status = data.status;
                if (data.subscribed !== undefined) subscribed = data.subscribed;
            }
            
            let html = `
                <h2 class="card-title"><i class="fas fa-file-alt"></i> Результат проверки подписки ${dataSourceBadge}</h2>
                
                <div class="subscription-status">
            `;
            
            if (status === 'ok') {
                if (subscribed === true) {
                    html += `
                        <i class="fas fa-check-circle status-icon active"></i>
                        <div class="status-text active">Подписка активна</div>
                    `;
                } else if (waiting === true) {
                    html += `
                        <i class="fas fa-clock status-icon" style="color: var(--warning-color);"></i>
                        <div class="status-text" style="color: var(--warning-color);">Ожидание подтверждения</div>
                    `;
                } else {
                    html += `
                        <i class="fas fa-times-circle status-icon inactive"></i>
                        <div class="status-text inactive">Подписка отсутствует</div>
                    `;
                }
            } else {
                html += `
                    <i class="fas fa-exclamation-circle status-icon inactive"></i>
                    <div class="status-text inactive">Ошибка проверки</div>
                `;
            }
            
            html += `</div>`;
            
            html += `
                <div class="subscription-details">
                    <div class="detail-item">
                        <div class="detail-label">Тип проверки</div>
                        <div class="detail-value">${config.name}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Поисковый запрос</div>
                        <div class="detail-value highlight">${searchValue}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Статус запроса</div>
                        <div class="detail-value">${status || 'не указан'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Статус подписки</div>
                        <div class="detail-value">
            `;
            
            if (status === 'ok') {
                if (subscribed === true) {
                    html += '<span class="status-success">Активна (subscribed: true)</span>';
                } else if (waiting === true) {
                    html += '<span class="status-warning">Ожидание подтверждения (waiting: true)</span>';
                } else {
                    html += '<span class="status-error">Отсутствует (subscribed: false)</span>';
                }
            } else {
                html += 'не удалось определить';
            }
            
            html += `</div></div>`;
            
            if (docflow.length > 0) {
                html += `<div class="detail-item">
                            <div class="detail-label">Документооборот</div>
                            <div class="detail-value">${docflow.length} записей</div>
                         </div>`;
                
                const firstDoc = docflow[0];
                html += `<div class="detail-item">
                            <div class="detail-label">Последняя запись</div>
                            <div class="detail-value">${firstDoc.title || 'Без названия'}</div>
                         </div>`;
                
                html += `<div class="detail-item">
                            <div class="detail-label">Дата последней записи</div>
                            <div class="detail-value">${firstDoc.date || 'Не указана'}</div>
                         </div>`;
            }
            
            html += `
                    <div class="detail-item" style="border-top: 2px solid var(--border-color); margin-top: 10px; padding-top: 10px;">
                        <div class="detail-label">Рекомендации</div>
                        <div class="detail-value">
            `;
            
            if (status !== 'ok') {
                html += `Запрос вернул ошибку. Проверьте корректность введенных данных.`;
            } else if (subscribed === true) {
                html += `Подписка активна. Клиент может использовать сервисы СЭДО.`;
            } else if (waiting === true) {
                html += `Подписка ожидает подтверждения. Клиенту необходимо завершить процедуру подписки.`;
            } else {
                html += `Подписка отсутствует. Клиенту необходимо обратиться в СФР (ФСС) для оформления подписки.`;
            }
            
            html += `</div></div></div>`;
            
            if (docflow.length > 0) {
                html += `
                    <div class="card" style="margin-top: 15px;">
                        <h3 class="card-title"><i class="fas fa-exchange-alt"></i> История документооборота (${docflow.length} записей)</h3>
                        <div class="info-grid">
                `;
                
                docflow.slice(0, 3).forEach((doc, index) => {
                    html += `
                        <div class="info-item">
                            <div class="info-label">Запись ${index + 1}</div>
                            <div class="info-value">
                                <div><strong>${doc.title || 'Без названия'}</strong></div>
                                <div style="font-size: 12px; color: var(--text-light);">${doc.date || ''}</div>
                                <div style="font-size: 11px; color: var(--text-light);">ID: ${doc.id || 'нет'}</div>
                            </div>
                        </div>
                    `;
                });
                
                if (docflow.length > 3) {
                    html += `
                        <div class="info-item">
                            <div class="info-label">И еще записей</div>
                            <div class="info-value">${docflow.length - 3}</div>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            }
            
            subscriptionResult.innerHTML = html;
            subscriptionResult.classList.add('active');
        }

        function showMessagesNotFound(searchValue, searchType) {
            let message = '';
            
            if (searchType === 'message') {
                message = `Сообщение с ID <strong>"${searchValue}"</strong> не найдено в системе СЭДО.`;
            } else {
                const config = MESSAGES_CONFIG[searchType];
                message = `По вашему запросу <strong>"${searchValue}"</strong> (${config.name}) не найдено документов.`;
            }
            
            messagesNotFoundMessage.innerHTML = message;
            messagesNotFoundPanel.classList.add('active');
            messagesContentContainer.innerHTML = '';
        }

        function showMessagesError(message) {
            messagesErrorMessage.innerHTML = message;
            messagesErrorPanel.classList.add('active');
            messagesNotFoundPanel.classList.remove('active');
        }

        function renderMessageData(data, isFallback = false) {
            const dataSourceBadge = isFallback ? 
                '<span class="status-warning" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-eye"></i> Демо-данные</span>' : 
                '<span class="status-success" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-server"></i> Онлайн</span>';
            
            let html = `
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-info-circle"></i> Основная информация ${dataSourceBadge}</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-fingerprint"></i> ID сообщения</div>
                                <div class="info-value highlight">${data.id || 'Не указан'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="far fa-calendar-alt"></i> Дата создания</div>
                                <div class="info-value">${data.date || 'Не указана'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-file-alt"></i> Тип сообщения</div>
                                <div class="info-value">${data.type || 'Не указан'}</div>
                            </div>
                            ${data.insurant && data.insurant.regnum ? `
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-user-shield"></i> Рег.номер страхователя</div>
                                <div class="info-value">${data.insurant.regnum}</div>
                            </div>` : ''}
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-history"></i> Статусы обработки</h2>
                        <div class="info-grid">
                            ${data.received_at ? `
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-inbox"></i> Получено</div>
                                <div class="info-value">${data.received_at}</div>
                            </div>` : ''}
                            ${data.processed_at ? `
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-cogs"></i> Обработано</div>
                                <div class="info-value">${data.processed_at}</div>
                            </div>` : ''}
                            ${data.delivered_at ? `
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-check-circle"></i> Доставлено</div>
                                <div class="info-value">${data.delivered_at}</div>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            if (data.messages && data.messages.length > 0) {
                html += `
                <div class="messages-container">
                    <div class="card">
                        <div class="messages-header">
                            <h2 class="card-title"><i class="fas fa-exchange-alt"></i> История сообщений</h2>
                        </div>
                        
                        <div class="messages-list" id="messagesList">
                `;
                
                data.messages.forEach((message, index) => {
                    const isExpanded = index === 0;
                    html += `
                        <div class="message-card ${isExpanded ? 'expanded' : ''}" data-message-id="${message.id || ''}">
                            <div class="message-header">
                                <div>
                                    <div class="message-title">${message.title || 'Без заголовка'}</div>
                                    ${message.date ? `<div class="message-date">${message.date}</div>` : ''}
                                </div>
                                ${message.type ? `<div class="message-type">Тип: ${message.type}</div>` : ''}
                            </div>
                            <div class="message-details" style="${isExpanded ? 'display: grid;' : 'display: none;'}">
                                ${message.id ? `
                                <div class="info-item">
                                    <div class="info-label">ID сообщения</div>
                                    <div class="info-value">${message.id}</div>
                                </div>` : ''}
                                ${message.received_at ? `
                                <div class="info-item">
                                    <div class="info-label">Получено</div>
                                    <div class="info-value">${message.received_at}</div>
                                </div>` : ''}
                                ${message.processed_at ? `
                                <div class="info-item">
                                    <div class="info-label">Обработано</div>
                                    <div class="info-value">${message.processed_at}</div>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div></div>`;
            }
            
            messagesContentContainer.innerHTML = html;
            
            setTimeout(() => {
                document.querySelectorAll('.message-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (e.target.closest('.message-details')) return;
                        this.classList.toggle('expanded');
                        const details = this.querySelector('.message-details');
                        if (details) {
                            details.style.display = this.classList.contains('expanded') ? 'grid' : 'none';
                        }
                    });
                });
            }, 100);
        }

        function renderDocumentsData(data, searchType, searchValue, startDate, endDate, isFallback = false) {
            const config = MESSAGES_CONFIG[searchType];
            const dataSourceBadge = isFallback ? 
                '<span class="status-warning" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-eye"></i> Демо-данные</span>' : 
                '<span class="status-success" style="margin-left: 10px; font-size: 12px;"><i class="fas fa-server"></i> Онлайн</span>';
            
            let html = `
                <div class="content-grid">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-search"></i> Результаты поиска ${dataSourceBadge}</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-search"></i> Тип поиска</div>
                                <div class="info-value">${config.name}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-hashtag"></i> Поисковый запрос</div>
                                <div class="info-value highlight">${searchValue}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="far fa-calendar-alt"></i> Период поиска</div>
                                <div class="info-value">${startDate} — ${endDate}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-server"></i> Сервер API</div>
                                <div class="info-value">${config.baseUrl.replace('https://', '')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> Статистика</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-file-alt"></i> Найдено документов</div>
                                <div class="info-value" style="font-size: 20px; color: var(--primary-color);">${Array.isArray(data) ? data.length : 1}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-clock"></i> Дата начала</div>
                                <div class="info-value">${startDate}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label"><i class="fas fa-clock"></i> Дата окончания</div>
                                <div class="info-value">${endDate}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (data && (Array.isArray(data) ? data.length > 0 : true)) {
                const documents = Array.isArray(data) ? data : [data];
                
                html += `
                    <div class="messages-container">
                        <div class="card">
                            <div class="messages-header">
                                <h2 class="card-title"><i class="fas fa-file-alt"></i> Найденные документы (${documents.length})</h2>
                            </div>
                            
                            <div class="documents-grid" id="documentsList">
                `;
                
                documents.forEach((document, index) => {
                    html += `
                        <div class="document-card">
                            <div class="document-title">${document.title || document.name || `Документ ${index + 1}`}</div>
                            ${document.id ? `<div class="document-id">ID: ${document.id}</div>` : ''}
                            
                            <div class="document-details">
                                ${document.date ? `
                                <div class="info-item">
                                    <div class="info-label">Дата</div>
                                    <div class="info-value">${document.date}</div>
                                </div>` : ''}
                                
                                ${document.type ? `
                                <div class="info-item">
                                    <div class="info-label">Тип</div>
                                    <div class="info-value">${document.type}</div>
                                </div>` : ''}
                                
                                ${document.status ? `
                                <div class="info-item">
                                    <div class="info-label">Статус</div>
                                    <div class="info-value ${document.status.toLowerCase().includes('успех') || document.status.toLowerCase().includes('success') ? 'status-success' : document.status.toLowerCase().includes('ошибка') || document.status.toLowerCase().includes('error') || document.status.toLowerCase().includes('fail') ? 'status-error' : ''}">${document.status}</div>
                                </div>` : ''}
                                
                                ${document.sender ? `
                                <div class="info-item">
                                    <div class="info-label">Отправитель</div>
                                    <div class="info-value">${document.sender}</div>
                                </div>` : ''}
                                
                                ${document.receiver ? `
                                <div class="info-item">
                                    <div class="info-label">Получатель</div>
                                    <div class="info-value">${document.receiver}</div>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div></div>`;
            } else {
                html += `
                    <div class="card">
                        <div class="messages-header">
                            <h2 class="card-title"><i class="fas fa-file-alt"></i> Результаты поиска</h2>
                        </div>
                        
                        <div class="info-item" style="text-align: center; padding: 30px;">
                            <i class="fas fa-inbox" style="font-size: 36px; color: var(--text-light); margin-bottom: 15px;"></i>
                            <div style="font-size: 16px; color: var(--text-light);">Документы не найдены</div>
                            <div style="margin-top: 10px; color: var(--text-light);">Попробуйте изменить параметры поиска</div>
                        </div>
                    </div>
                `;
            }
            
            messagesContentContainer.innerHTML = html;
        }

        function generateCacheKey(type, params) {
            return `${type}_${JSON.stringify(params)}`;
        }

        function setupAnimationOptimization() {
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    pauseBackgroundAnimations();
                } else {
                    resumeBackgroundAnimations();
                }
            });
        }

        function pauseBackgroundAnimations() {
            const lava = document.getElementById('bgLava');
            if (lava) {
                const blobs = lava.querySelectorAll('.lava-blob');
                const bubbles = lava.querySelectorAll('.lava-bubble');
                
                blobs.forEach(blob => {
                    blob.style.animationPlayState = 'paused';
                });
                
                bubbles.forEach(bubble => {
                    bubble.style.animationPlayState = 'paused';
                });
            }
        }

        function resumeBackgroundAnimations() {
            const lava = document.getElementById('bgLava');
            if (lava) {
                const blobs = lava.querySelectorAll('.lava-blob');
                const bubbles = lava.querySelectorAll('.lava-bubble');
                
                blobs.forEach(blob => {
                    blob.style.animationPlayState = 'running';
                });
                
                bubbles.forEach(bubble => {
                    bubble.style.animationPlayState = 'running';
                });
            }
        }
    </script>
</body>
</html>
